<!DOCTYPE html>

<html>
<head>
  <title>server.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>server.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Get dependencies</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);
<span class="hljs-keyword">const</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'body-parser'</span>);
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>); 
<span class="hljs-keyword">const</span> ta = <span class="hljs-built_in">require</span>(<span class="hljs-string">'time-ago'</span>);
<span class="hljs-keyword">const</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express-session'</span>);
<span class="hljs-keyword">const</span> sharedsession = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express-socket.io-session"</span>);
<span class="hljs-keyword">const</span> hbs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express-handlebars'</span>)
<span class="hljs-keyword">const</span> cookieParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cookie-parser'</span>);
<span class="hljs-keyword">const</span> flash = <span class="hljs-built_in">require</span>(<span class="hljs-string">'connect-flash'</span>);
<span class="hljs-keyword">const</span> morgan = <span class="hljs-built_in">require</span>(<span class="hljs-string">'morgan'</span>);
<span class="hljs-keyword">const</span> rfs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'rotating-file-stream'</span>);
<span class="hljs-keyword">const</span> cmd=<span class="hljs-built_in">require</span>(<span class="hljs-string">'./app/cmd'</span>);
<span class="hljs-keyword">const</span> notify = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./app/notify'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>const async = require(‘async’)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>


<span class="hljs-keyword">const</span> app = express();

<span class="hljs-keyword">var</span> logDirectory = path.join(__dirname, <span class="hljs-string">'log'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>ensure log directory exists</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>fs.existsSync(logDirectory) || fs.mkdirSync(logDirectory)</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>create a rotating write stream</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> accessLogStream = rfs(<span class="hljs-string">'access.log'</span>, {
  <span class="hljs-attr">interval</span>: <span class="hljs-string">'1d'</span>, <span class="hljs-comment">// rotate daily</span>
  path: logDirectory
})</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>setup the logger</p>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Get our API routes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> config = {
	<span class="hljs-attr">db</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">'./config/db'</span>),
	<span class="hljs-attr">authentication</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">'./app/auth'</span>),
	<span class="hljs-attr">search</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">'./app/search'</span>),
	<span class="hljs-attr">upload</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">'./app/upload'</span>),
	<span class="hljs-attr">activity</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">'./app/activity'</span>),
	<span class="hljs-attr">chat</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">'./app/chat'</span>),
	<span class="hljs-attr">user</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">'./app/user'</span>),
	<span class="hljs-attr">code</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">'./app/code'</span>)
}

mongoose.connect(config.db.url);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>mongoose.connect(“mongodb://uohbduorkfqofhp:<a href="mailto:3ZhDHgCpy75R1i0TULax@b6eo0yayiuwct4v-mongodb.services.clever-cloud.com">3ZhDHgCpy75R1i0TULax@b6eo0yayiuwct4v-mongodb.services.clever-cloud.com</a>:27017/b6eo0yayiuwct4v”);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> feeds = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./app/models/feeds'</span>);
<span class="hljs-keyword">const</span> users = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./app/models/user'</span>);
<span class="hljs-keyword">const</span> room = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./app/models/room'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Parsers for POST data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
app.use(morgan(<span class="hljs-string">'tiny'</span>, { <span class="hljs-attr">stream</span>: accessLogStream }))</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>app.use(morgan(‘dev’));</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>app.use(cookieParser());

<span class="hljs-keyword">var</span> cooky = {
	<span class="hljs-attr">secret</span>: <span class="hljs-string">'work hard'</span>,
  	<span class="hljs-attr">resave</span>: <span class="hljs-literal">true</span>,
  	<span class="hljs-attr">expires</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">24</span> * <span class="hljs-number">7</span>,
  	<span class="hljs-attr">saveUninitialized</span>: <span class="hljs-literal">true</span>
}
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> }));
app.set(<span class="hljs-string">'trust proxy'</span>, <span class="hljs-number">1</span>) <span class="hljs-comment">// trust first proxy</span>
app.use(flash())
app.use(session(cooky))

app.set(<span class="hljs-string">'view engine'</span>, <span class="hljs-string">'hbs'</span>); 
app.engine( <span class="hljs-string">'hbs'</span>, hbs( { 
	<span class="hljs-attr">extname</span>: <span class="hljs-string">'.hbs'</span>
}));</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Point static path to dist</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>app.use(express.static(path.join(__dirname, <span class="hljs-string">'./bin'</span>)));</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Set our routes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>app.use(<span class="hljs-string">'/auth'</span>, config.authentication);
app.use(<span class="hljs-string">'/upload'</span>, config.upload);
app.use(<span class="hljs-string">'/search'</span>, config.search);
app.use(<span class="hljs-string">'/activity'</span>, config.activity);
app.use(<span class="hljs-string">'/user'</span>, config.user);
app.use(<span class="hljs-string">'/chat'</span>, config.chat);
app.use(<span class="hljs-string">'/learn'</span>, config.code);</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>app.use(‘/profile’, user);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">const</span> server = http.createServer(app);

<span class="hljs-keyword">var</span> clients = []

<span class="hljs-keyword">const</span> io = <span class="hljs-built_in">require</span>(<span class="hljs-string">'socket.io'</span>)(server);

app.io = io;

<span class="hljs-keyword">var</span> nsp = io.of(<span class="hljs-string">'/chat'</span>);
<span class="hljs-keyword">var</span> service = io.of(<span class="hljs-string">'/services'</span>);
<span class="hljs-keyword">var</span> code = io.of(<span class="hljs-string">'/code'</span>);
nsp.use(sharedsession(session(cooky), {
	<span class="hljs-attr">autoSave</span>: <span class="hljs-literal">true</span>
}));

nsp.on(<span class="hljs-string">'connection'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">socket</span>)</span>{
	socket.emit(<span class="hljs-string">'init'</span>);
	socket.on(<span class="hljs-string">'join'</span>, room =&gt; {
		socket.join(room);
			}) 
		socket.on(<span class="hljs-string">'msg'</span>, (data) =&gt;{
			room
			.findOne({<span class="hljs-attr">_id</span>:data.roomid})
			.exec(<span class="hljs-function">(<span class="hljs-params">err, chatRoom</span>) =&gt;</span> {
				chatRoom.chats.push({
					<span class="hljs-attr">txt</span>:data.txt,
					<span class="hljs-attr">by</span>:data.user,
					<span class="hljs-attr">time</span>:<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
				})
				chatRoom.save(<span class="hljs-function">(<span class="hljs-params">err, theChatSaveRes</span>) =&gt;</span> {
					nsp.to(data.roomid).emit(<span class="hljs-string">'msg'</span>, {
						<span class="hljs-attr">txt</span>:data.txt,
						<span class="hljs-attr">user</span>: data.user,
						<span class="hljs-attr">time</span>:<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
						<span class="hljs-attr">to</span>:data.targetUser
					})
				})
				
			})
			
		})
}); 


service.on(<span class="hljs-string">'connection'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">socket</span>)</span>{ 

    socket.on(<span class="hljs-string">'like'</span> , post =&gt; {
    	<span class="hljs-built_in">console</span>.log(post)
    	feeds
    	.findOne({<span class="hljs-attr">_id</span>:post.id})
    	.exec(<span class="hljs-function">(<span class="hljs-params">err, res</span>) =&gt;</span> {
    		<span class="hljs-keyword">var</span> found = <span class="hljs-literal">false</span>;
    		res.disabledFor.map(<span class="hljs-function">(<span class="hljs-params">value, indexOf</span>) =&gt;</span> {
    			<span class="hljs-keyword">if</span>(value = post.initiater) {
    				<span class="hljs-keyword">return</span> found = <span class="hljs-literal">true</span>;
    			}
    		})
    		<span class="hljs-keyword">if</span>(!found) {
    			res.likes = res.likes+<span class="hljs-number">1</span>;
	    		res.disabledFor.push(post.initiater);
	    		res.save(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
	    			socket.emit(<span class="hljs-string">'disabled'</span>, post.id);
	    			notify.broadcast(post.initiater+<span class="hljs-string">" just liked a post."</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>console.info(‘{LIKED} : ‘+post.initiater)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	    		})
    		}
    		<span class="hljs-keyword">else</span> {
    			socket.emit(<span class="hljs-string">'disabled'</span>, post.id)
    		}
    		
    	})
    })
    socket.on(<span class="hljs-string">'comment'</span> , post =&gt; {
    	<span class="hljs-built_in">console</span>.log(post)
    	feeds
    	.findOne({<span class="hljs-attr">_id</span>:post.id})
    	.exec(<span class="hljs-function">(<span class="hljs-params">err, res</span>) =&gt;</span> {
    		
    			
	    		res.comments.push({<span class="hljs-attr">user</span>:post.initiater,<span class="hljs-attr">comment</span>:post.text,<span class="hljs-attr">time</span>:<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()});
	    		res.save(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
	    			socket.emit(<span class="hljs-string">'commented'</span>, post);
	    			notify.broadcast(post.initiater+<span class="hljs-string">" just posted a comment "</span>+post.text);
	    			<span class="hljs-built_in">console</span>.info(<span class="hljs-string">'{COMMENTED} : '</span>+post.initiater)
	    		})
    	
    	})
    })
});
code.on(<span class="hljs-string">'connection'</span>, (socket) =&gt; {
	socket.on(<span class="hljs-string">'run'</span>, code_data =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>console.log(code_data)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> fileName = <span class="hljs-string">'code.'</span>+code_data.name;
		<span class="hljs-keyword">var</span> codeFile = fs.createWriteStream(fileName);
		codeFile.write(code_data.code ,()=&gt; {

			cmd.get(code_data.lang+<span class="hljs-string">' ./'</span>+fileName,(something, output_exec, stderr) =&gt; {
			<span class="hljs-keyword">if</span>(output_exec) {	
				socket.emit(<span class="hljs-string">'result'</span>,output_exec)		
			}
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(stderr) {
				socket.emit(<span class="hljs-string">'result'</span>,stderr)			
				}
			})
			
		});
		
	})
})</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Catch all other routes and return the index file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>app.get(<span class="hljs-string">'/'</span>, (req, res) =&gt; {

	<span class="hljs-keyword">if</span>(!req.session.user) {</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>req.flash(‘info’,’Redirecting…’)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span>(req.query.light) {	
		res.render(<span class="hljs-string">'login'</span>, {
			<span class="hljs-attr">layout</span>:<span class="hljs-literal">false</span>,
			<span class="hljs-attr">light</span>:<span class="hljs-literal">true</span>
		});
		}
		<span class="hljs-keyword">else</span> {
			res.render(<span class="hljs-string">'login'</span>, {
			<span class="hljs-attr">layout</span>:<span class="hljs-literal">false</span>,
			<span class="hljs-attr">normal</span>:<span class="hljs-literal">true</span>
		});
		}
	}
	<span class="hljs-keyword">else</span> {
	
	feeds
	.find({})
	
	.exec( <span class="hljs-function">(<span class="hljs-params">err,e</span>) =&gt;</span> {
	 
<span class="hljs-keyword">var</span> finalData = e.map(<span class="hljs-function">(<span class="hljs-params">val, index</span>)=&gt;</span> {
	<span class="hljs-keyword">var</span> disabled = <span class="hljs-literal">false</span>;
	val.disabledFor.map(<span class="hljs-function">(<span class="hljs-params">userFound, indexOfUser</span>) =&gt;</span>{
		<span class="hljs-keyword">if</span>(userFound = req.session.user) <span class="hljs-keyword">return</span> disabled = <span class="hljs-literal">true</span>;
	})
	<span class="hljs-keyword">var</span> data={
				<span class="hljs-attr">author</span>:val.author,
				<span class="hljs-attr">pudding</span>:val.pudding,
				<span class="hljs-attr">timeago</span>:ta.ago(val.timeago),
				<span class="hljs-attr">likes</span>:val.likes,
				<span class="hljs-attr">disabled</span>:disabled,
				<span class="hljs-attr">caption</span>:val.caption,
				<span class="hljs-attr">comments</span>:val.comments,
				<span class="hljs-attr">_id</span>:val._id
			}
	<span class="hljs-keyword">return</span> data

})</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>console.log(finalData)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span>(req.query.light) {	
		res.render(<span class="hljs-string">'index'</span>, {
		<span class="hljs-attr">layout</span>:<span class="hljs-literal">false</span>,
		<span class="hljs-attr">post</span>: finalData,
		<span class="hljs-attr">client</span>: req.session.user,
		<span class="hljs-attr">light</span>: <span class="hljs-literal">true</span>
		})
		}
		<span class="hljs-keyword">else</span> {
			res.render(<span class="hljs-string">'index'</span>, {
		<span class="hljs-attr">layout</span>:<span class="hljs-literal">false</span>,
		<span class="hljs-attr">post</span>: finalData,
		<span class="hljs-attr">client</span>: req.session.user,
		<span class="hljs-attr">normal</span>: <span class="hljs-literal">true</span>
		})
		}
	
	})</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>.then(function(results) {</p>

            </div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>})</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  }
	
});
app.get(<span class="hljs-string">'/logs'</span>, (req, res) =&gt; {
	fs.readFile(<span class="hljs-function">(<span class="hljs-params">__dirname+<span class="hljs-string">'/log/access.log'</span></span>), (<span class="hljs-params">a,contents</span>)=&gt;</span> {
		
		res.render(<span class="hljs-string">'log'</span>, {
			<span class="hljs-attr">layout</span>:<span class="hljs-literal">false</span>,
			<span class="hljs-attr">logs</span>:contents
		})	
	});
	
})

<span class="hljs-comment">/**
 * Get port from environment and store in Express.
 */</span>
<span class="hljs-keyword">const</span> port = process.env.PORT || <span class="hljs-string">'2374'</span>;
app.set(<span class="hljs-string">'port'</span>, port);

<span class="hljs-comment">/**
 * Create HTTP server.
 */</span>


<span class="hljs-comment">/**
 * Listen on provided port, on all network interfaces.
 */</span>
server.listen(port, () =&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`API running on localhost:<span class="hljs-subst">${port}</span>`</span>));</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
